// Filename: rocktimer.full.js  
// Timestamp: 2014/03/01 (last modified)  
// Author(s): Bumblehead (www.bumblehead.com)  

var incrnum=("object"==typeof module?module:{}).exports=function(n,t){return t=function(){return n++},t.toString=function(){return n++},t}(0);var eventhook=("object"==typeof module?module:{}).exports=function(){var n={fnArr:[],addFn:function(n){"function"==typeof n&&(n.oname="fn"+incrnum,this.fnArr.push(n))},rmFn:function(n){var r=n.oname;"function"==typeof n&&(this.fnArr=this.fnArr.filter(function(n){return n.oname!==r}))},fire:function(n,r,t,o){this.fnArr.map(function(e){e(n,r,t,o)})}};return{proto:n,getNew:function(){var r=Object.create(n);return r.fnArr=[],r}}}();var rocktimerms=("object"==typeof module?module:{}).exports=function(t){var e=Math.floor,n={ms:0,mstotal:0,remaining:null,toString:function(){return this.ms},ashh:function(){return e(this.ms/36e5)},asmm:function(){return e(this.ms/6e4)},asss:function(){return e(this.ms/1e3)},asms:function(){return e(this.ms)}};return t=function(t,e){var r=Object.create(n);return r.ms=t,r.mstotal=e,r.remaining=Object.create(r),r.remaining.ms=e-t+1e-7,r},t.proto=n,t.getms=function(t){var e=0;return"object"==typeof t&&t&&("number"==typeof t.hh&&(e+=36e5*t.hh),"number"==typeof t.mm&&(e+=6e4*t.mm),"number"==typeof t.ss&&(e+=1e3*t.ss),"number"==typeof t.ms&&(e+=t.ms)),e},t}();var mlcm=("object"==typeof module?module:{}).exports=function(n){function e(n){return n.reduce(function e(n,r){return 0===r?n:e(r,n%r)})}function r(n){return n.reduce(function(n,r){return Math.abs(n*r)/e([n,r])})}return n=r,n.lcm=r,n.gcd=e,n}();var rocktimerframes=("object"==typeof module?module:{}).exports={getPossibleFramesGCD:function(t,r){var n=+r;return t.length&&(n=mlcm.gcd(t.map(function(t){return t.ms}))),n},buildObj:function(t,r,n){var e={},m=rocktimerms(r,n),s=t.filter(function(t){return 0===r||r%t.ms===0&&r>=t.ms});return s.length&&(e=function(){s.map(function(t){t(m)})}),e.msObj=m,e},buildObjArr:function(t,r){for(var n=this,e=n.getPossibleFramesGCD(t,r),m=Math.ceil(r/e),s=-1,u=[];++s<=m;)u.push(n.buildObj(t,e*s,r));return u.ms=r,u.mspf=e,u.framesnum=m,u.callframe=function(t,r){return"function"==typeof(r=this[t])&&r()},u.getframemsObj=function(t,r){return(r=this[t])&&r.msObj},u.getmsIndexNum=function(t){for(var r=this.length;r--;)if(this[r].msObj.ms===t)return r},u}};var rocktimer=("object"==typeof module?module:{}).exports=function(e){var t={timer:null,ms:0,msextended:0,getms:rocktimerms.getms,isActive:function(){return null===this.timer?!1:!0},getFrameObjCur:function(){return this.framesArr[this.frameindex]},onStop:function(e){return this.onStopHook.addFn(e),this},onClear:function(e){return this.onClearHook.addFn(e),this},onStart:function(e){return this.onStartHook.addFn(e),this},onExtend:function(e){return this.onExtendHook.addFn(e),this},callStop:function(){this.onStopHook.fire(this.getFrameObjCur().msObj)},callClear:function(){this.onClearHook.fire(this.getFrameObjCur().msObj)},callStart:function(){this.onStartHook.fire(this.getFrameObjCur().msObj)},callExtend:function(){this.onExtendHook.fire(this.getFrameObjCur().msObj)},getRemainingms:function(){var e=this,t=e.framesArr,r=t.length-e.frameindex;return r*t.mspf},forEach:function(e,t){var r,n,a=this,o=a.getms(e);if("number"!=typeof o)throw new Error("invalid timeopts");if("function"!=typeof t)throw new Error("invalid function");if(1===a.st)throw new Error("invalid forEach during animate");return t.ms=o,a.foreachArr.push(t),n=rocktimerframes.buildObjArr(a.foreachArr,a.msextended),a.frameindex&&(r=a.framesArr[a.frameindex].msObj.ms,r=n.getmsIndexNum(r)),a.framesArr=n,a.frameindex=r||0,a},updateFrameState:function(e,t,r){return 1===r&&e>=t.length&&(r=4),r},animate:function(){var e=this;!function t(r,n){switch(n=e.framesArr,e.st=e.updateFrameState(++e.frameindex,n,e.st),e.st){case 1:n.callframe(e.frameindex),e.timer=setTimeout(t,n.mspf);break;case 2:e.st=1;break;case 3:e.st=3,e.clear();break;default:e.st=4,e.frameindex--,e.complete()}}()},clearInterval:function(){var e=this;e.timer&&(clearInterval(e.timer),e.timer=null)},reset:function(){var e=this;return 1===e.st&&(e.st=2,e.clearInterval()),e.msextended=+e.ms,e.framesArr=rocktimerframes.buildObjArr(e.foreachArr,e.msextended),e.clear(),e},extend:function(e){var t=this,r=t.msextended+t.getms(e);return t.framesArr=rocktimerframes.buildObjArr(t.foreachArr,r),t.msextended=r,t.callExtend(),t},complete:function(){var e=this;1===e.st&&(e.st=4,e.clearInterval()),e.callStop()},stop:function(){var e=this;return 1===e.st&&(e.st=2,e.clearInterval(),e.callStop()),e},clear:function(){var e=this;return e.frameindex=0,e.callClear(),1!==e.st&&(e.st=4,e.clearInterval()),e},start:function(){var e=this,t=e.st;return(4===t||2===t)&&(4===t&&0===e.frameindex&&(e.bgnDate=new Date),e.callStart(),e.st=1,e.animate()),e},reinit:function(){var e=this;return e.clear(),e.st=4,e.init(),e}};return e=function(e){var r=Object.create(t);return r.onClearHook=eventhook.getNew(),r.onStartHook=eventhook.getNew(),r.onStopHook=eventhook.getNew(),r.onExtendHook=eventhook.getNew(),r.bgnDate=new Date,r.frameindex=0,r.foreachArr=[],r.timer=null,r.ms=r.getms(e)||0,r.msextended=+r.ms,r.st=4,r.framesArr=rocktimerframes.buildObjArr([],r.msextended),r},e.proto=t,e}();